insightaura.duckdns.org, *.insightaura.duckdns.org {
    tls {env.EMAIL} {
        dns duckdns {env.DUCKDNS_TOKEN}
    }

    encode gzip zstd

    log {
        output file /var/log/caddy/access.log
        format json
    }

    # Reverse proxy for APIs and tools
    handle /api/* {
        reverse_proxy backend:8000
    }

    handle /airflow/* {
        reverse_proxy airflow_standalone:8080
    }

    handle /grafana/* {
        reverse_proxy grafana:3001
    }

    handle /mlflow/* {
        reverse_proxy mlflow:5001
    }

    # Important: Use `handle` instead of `handle_path` for static files to avoid Next.js asset path stripping
    @static {
        path_regexp static \.(js|css|png|jpg|jpeg|gif|ico|svg|woff2?|ttf|eot)$
    }

    handle @static {
        header Cache-Control "public, max-age=31536000, immutable"
        reverse_proxy frontend:3000
    }

    # Catch-all (SSR and routing)
    handle {
        reverse_proxy frontend:3000
    }
}
