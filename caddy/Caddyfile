{
    email {env.EMAIL}
    auto_https disable_redirects
}

# Shared configuration for all domains
(common_config) {
    tls {
        dns duckdns {env.DUCKDNS_TOKEN}
    }
    encode gzip zstd
    log {
        output file /var/log/caddy/{args[0]}.log
        format json
    }
}

# Main domain - Frontend
insightaura.duckdns.org {
    import common_config "main"

    # Security headers for all responses
    header {
        # Security headers
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Referrer-Policy "strict-origin-when-cross-origin"
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        
        # Cache control for static assets
        Cache-Control "public, max-age=31536000, immutable" {
            /_next/static/*
            /static/*
            /fonts/*
            /images/*
        }
    }

    # Next.js static assets
    handle /_next/* {
        reverse_proxy frontend:3000 {
            header_up Host {host}
            header_up X-Forwarded-Proto https
        }
    }

    # Static files
    handle /static/* {
        reverse_proxy frontend:3000 {
            header_up Host {host}
            header_up X-Forwarded-Proto https
        }
    }

    # API proxy
    handle /api/* {
        reverse_proxy backend:8000 {
            header_up Host {host}
            header_up X-Forwarded-Proto https
        }
    }

    # Health checks
    handle /health {
        reverse_proxy frontend:3000
    }

    # Primary route - all other requests
    handle {
        reverse_proxy frontend:3000 {
            header_up Host {host}
            header_up X-Forwarded-Proto https
            header_up Connection {http.request.header.Connection}
            header_up Upgrade {http.request.header.Upgrade}
        }
    }
}

# API subdomain
api.insightaura.duckdns.org {
    import common_config "api"
    reverse_proxy backend:8000 {
        header_up Host {host}
        header_up X-Forwarded-Proto https
    }
}

# Airflow subdomain
airflow.insightaura.duckdns.org {
    import common_config "airflow"

    # Handle websockets first
    @websockets {
        header Connection *Upgrade*
        header Upgrade websocket
    }
    handle @websockets {
        reverse_proxy airflow_standalone:8080 {
            transport http {
                tls_insecure_skip_verify
            }
        }
    }

    # Regular requests
    handle {
        reverse_proxy airflow_standalone:8080 {
            transport http {
                tls_insecure_skip_verify
            }
            header_up Host {host}
            header_up X-Forwarded-Proto https
            header_up X-Forwarded-Host {host}
            header_up X-Real-IP {remote}
        }
    }
}

# Grafana subdomain
grafana.insightaura.duckdns.org {
    import common_config "grafana"
    reverse_proxy grafana:3001 {
        header_up Host {host}
        header_up X-Forwarded-Proto https
        header_up X-Forwarded-Host {host}
    }
}

# MLflow subdomain
mlflow.insightaura.duckdns.org {
    import common_config "mlflow"
    reverse_proxy mlflow:5001 {
        header_up Host {host}
        header_up X-Forwarded-Proto https
    }
}

# Prometheus subdomain
prometheus.insightaura.duckdns.org {
    import common_config "prometheus"
    reverse_proxy prometheus:9090 {
        header_up Host {host}
        header_up X-Forwarded-Proto https
    }
}