{
    email {env.EMAIL}
    auto_https disable_redirects
}

# Shared configuration for all domains
(common_config) {
    tls {
        dns duckdns {env.DUCKDNS_TOKEN}
    }
    encode gzip zstd
    log {
        output file /var/log/caddy/{args.0}.log
        format json
    }
}

# Main domain - Frontend 
insightaura.duckdns.org {
    import common_config "main"
    
    # Next.js specific routes
    handle /_next/* {
        reverse_proxy frontend:3000 {
            header_up Host {host}
            header_up X-Forwarded-Proto https
        }
    }
    
    handle /static/* {
        reverse_proxy frontend:3000 {
            header_up Host {host}
            header_up X-Forwarded-Proto https
        }
    }
    
    # API proxy
    handle /api/* {
        reverse_proxy backend:8000 {
            header_up Host {host}
            header_up X-Forwarded-Proto https
        }
    }
    
    # Health checks
    handle /health {
        reverse_proxy frontend:3000 {
            header_up Host {host}
            header_up X-Forwarded-Proto https
        }
    }
    
    # All other requests go to Next.js
    handle {
        reverse_proxy frontend:3000 {
            header_up Host {host}
            header_up X-Forwarded-Proto https
        }
    }
}

# API 
api.insightaura.duckdns.org {
    import common_config "api"
    
    # Reverse proxy to backend
    reverse_proxy backend:8000 {
        header_up Host {host}
        header_up X-Forwarded-Proto https
    }
}

# Airflow 
airflow.insightaura.duckdns.org {
    import common_config "airflow"
    
    # Reverse proxy to Airflow
    reverse_proxy airflow_standalone:8080 {
        header_up Host {host}
        header_up X-Forwarded-Proto https
        
        # Needed for Airflow webserver
        transport http {
            tls_insecure_skip_verify
        }
    }
}

# Grafana 
grafana.insightaura.duckdns.org {
    import common_config "grafana"
    
    # Reverse proxy to Grafana
    reverse_proxy grafana:3001 {
        header_up Host {host}
        header_up X-Forwarded-Proto https
    }
}

# MLflow 
mlflow.insightaura.duckdns.org {
    import common_config "mlflow"
    reverse_proxy mlflow:5001 {
        header_up Host {host}
        header_up X-Forwarded-Proto https
    }
}

# Prometheus 
prometheus.insightaura.duckdns.org {
    import common_config "prometheus"
    
    # Reverse proxy to Prometheus
    reverse_proxy prometheus:9090 {
        header_up Host {host}
        header_up X-Forwarded-Proto https
    }
}