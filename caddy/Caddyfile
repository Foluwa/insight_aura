{
    email {env.EMAIL}
}

# Main domain - Frontend
insightaura.duckdns.org {
    tls {
        dns duckdns {env.DUCKDNS_TOKEN}
    }

    encode gzip zstd

    log {
        output file /var/log/caddy/main.log
        format json
    }

    # Serve Next.js assets
    handle_path /_next/* {
        reverse_proxy frontend:3000
    }

    # Static assets
    @static {
        path *.js *.css *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot
    }
    handle @static {
        header Cache-Control "public, max-age=31536000, immutable"
        reverse_proxy frontend:3000
    }

    # API proxy
    handle_path /api/* {
        reverse_proxy backend:8000
    }

    # Fallback to frontend
    handle {
        reverse_proxy frontend:3000
    }
}


# MLflow subdomain
mlflow.insightaura.duckdns.org {
    tls {
        dns duckdns {env.DUCKDNS_TOKEN}
    }

    encode gzip zstd

    log {
        output file /var/log/caddy/mlflow.log
        format json
    }

    reverse_proxy mlflow:5001
}

# Airflow subdomain
airflow.insightaura.duckdns.org {
    tls {
        dns duckdns {env.DUCKDNS_TOKEN}
    }

    encode gzip zstd

    log {
        output file /var/log/caddy/airflow.log
        format json
    }

    reverse_proxy airflow_standalone:8080
}

# Grafana subdomain
grafana.insightaura.duckdns.org {
    tls {
        dns duckdns {env.DUCKDNS_TOKEN}
    }

    encode gzip zstd

    log {
        output file /var/log/caddy/grafana.log
        format json
    }

    reverse_proxy grafana:3001
}

# Optional: API subdomain (if you want to separate API from main domain)
api.insightaura.duckdns.org {
    tls {
        dns duckdns {env.DUCKDNS_TOKEN}
    }

    encode gzip zstd

    log {
        output file /var/log/caddy/api.log
        format json
    }

    reverse_proxy backend:8000
}